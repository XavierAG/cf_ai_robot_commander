<!DOCTYPE html>
<html>
<head>
    <title>Robot Command Center</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #00ff41; padding: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .robot-card { border: 1px solid #00ff41; padding: 15px; background: #111; box-shadow: 0 0 10px #00ff4133; }
        .progress-bg { background: #222; height: 20px; width: 100%; margin: 10px 0; border: 1px solid #333; }
        .progress-fill { background: #00ff41; height: 100%; width: 0%; transition: width 0.5s linear; }
        .log { font-size: 0.8em; color: #888; height: 60px; overflow-y: auto; border-top: 1px solid #333; padding-top: 5px; }
        h1 { border-bottom: 2px solid #00ff41; padding-bottom: 10px; text-transform: uppercase; }
        input, button { background: #000; color: #00ff41; border: 1px solid #00ff41; padding: 5px; font-family: inherit; }
        button { cursor: pointer; font-weight: bold; background: #004400; }
        button:hover { background: #00ff41; color: #000; }
    </style>
</head>
<body>
    <h1>üì° Live Fleet Status</h1>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
        <div style="border: 1px solid #00ff41; padding: 15px; background: #111;">
            <h3>üèóÔ∏è Room Spawner</h3>
            <input type="text" id="roomName" placeholder="Room Name" style="width: 40%;">
            <input type="number" id="roomX" placeholder="X" style="width: 20%;">
            <input type="number" id="roomY" placeholder="Y" style="width: 20%;">
            <button onclick="addRoom()">Add</button>
        </div>
        <div style="border: 1px solid #00ff41; padding: 15px; background: #111;">
            <h3>ü§ñ Robot Enroller</h3>
            <input type="text" id="botId" placeholder="Robot Name" style="width: 40%;">
            <input type="text" id="botRole" placeholder="Role" style="width: 40%;">
            <button onclick="addRobot()">Assign</button>
        </div>
    </div>

    <div style="margin-bottom: 30px; border: 1px solid #00ff41; padding: 15px;">
        <input type="text" id="cmdInput" placeholder="Ex: Send Billy to the kitchen to make burgers" style="width: 80%; padding: 10px;">
        <button onclick="sendCommand()" style="padding: 10px;">DEPLOY</button>
    </div>

    <div style="margin-top: 20px; border: 1px solid #00ff41; padding: 15px; background: #000; display: grid; grid-template-columns: 1fr 300px; gap: 20px; margin-bottom: 30px;">
        <div>
            <h3>üåç World Registry</h3>
            <div style="display: flex; gap: 40px;">
                <div><h4>üìç Rooms</h4><ul id="roomList" style="list-style: none; padding: 0;"></ul></div>
                <div><h4>üéñÔ∏è Roster</h4><ul id="roleList" style="list-style: none; padding: 0;"></ul></div>
            </div>
        </div>
        <div style="text-align: center;">
            <h4>üó∫Ô∏è Live Map</h4>
            <canvas id="minimap" width="250" height="250" style="border: 1px solid #333; background: #050505;"></canvas>
        </div>
    </div>

    <div id="fleet" class="grid"></div>

    <script>
        const robotPositions = {};
        const roomCoords = {};
        const WORKER_URL = "wss://robot-command-center.xavierart2001.workers.dev/ws?robotId=CENTRAL_HUB";        
        const socket = new WebSocket(WORKER_URL);
        const fleet = document.getElementById('fleet');
        const robots = {};

        async function sendCommand() {
            const prompt = document.getElementById('cmdInput').value;
            await fetch('https://robot-command-center.xavierart2001.workers.dev/api/command', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt })
            });
            document.getElementById('cmdInput').value = '';
        }

        async function addRoom() {
    const name = document.getElementById('roomName').value;
    const x = parseFloat(document.getElementById('roomX').value);
    const y = parseFloat(document.getElementById('roomY').value);

    if (x < -25 || x > 25 || y < -25 || y > 25) {
        alert("‚ö†Ô∏è Error: Coordinates must be within the 50x50 grid (-25 to 25).");
        return;
    }
    
    const response = await fetch('https://robot-command-center.xavierart2001.workers.dev/api/rooms', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, x, y })
    });
    
    const res = await response.json();
    if(res.success) {
        refreshWorldData();
    } else {
        alert(res.message);
    }
}

        async function addRobot() {
            const robotId = document.getElementById('botId').value;
            const role = document.getElementById('botRole').value;
            await fetch('https://robot-command-center.xavierart2001.workers.dev/api/roles', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ robotId, role })
            });
            refreshWorldData();
        }

        async function deleteRoom(name) {
            await fetch(`https://robot-command-center.xavierart2001.workers.dev/api/rooms/${name}`, { method: 'DELETE' });
            refreshWorldData();
        }

        async function deleteRobot(id) {
            await fetch(`https://robot-command-center.xavierart2001.workers.dev/api/roles/${id}`, { method: 'DELETE' });
            refreshWorldData();
        }

        function drawMap(rooms) {
    const canvas = document.getElementById('minimap');
    const ctx = canvas.getContext('2d');
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    const scale = 5;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.strokeStyle = '#330000';
    ctx.lineWidth = 2;
    ctx.strokeRect(centerX - (25 * scale), centerY - (25 * scale), 50 * scale, 50 * scale);
    ctx.strokeStyle = '#111';
    ctx.lineWidth = 1;
    for(let i=0; i<=250; i+=25) {
        ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,250); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(250,i); ctx.stroke();
    }
    rooms.forEach(room => {
        roomCoords[room.name] = { x: room.x, y: room.y };
        const x = centerX + (room.x * scale);
        const y = centerY - (room.y * scale);
        ctx.fillStyle = room.name === 'Spawner' ? '#ff00ff' : '#008844';
        ctx.beginPath(); ctx.arc(x, y, 4, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#666';
        ctx.fillText(room.name, x + 8, y + 3);
    });
    Object.entries(robotPositions).forEach(([id, pos]) => {
        const x = centerX + (pos.x * scale);
        const y = centerY - (pos.y * scale);
        ctx.shadowBlur = 10; ctx.shadowColor = "#00ff41";
        ctx.fillStyle = "#00ff41";
        ctx.beginPath(); ctx.arc(x, y, 5, 0, Math.PI * 2); ctx.fill();
        ctx.shadowBlur = 0; ctx.fillStyle = "#fff";
        ctx.fillText(id, x - 15, y - 10);
    });
}

        async function refreshWorldData() {
            const res = await fetch('https://robot-command-center.xavierart2001.workers.dev/api/world');
            const { rooms, roles } = await res.json();
            document.getElementById('roomList').innerHTML = rooms.map(r => `<li><button onclick="deleteRoom('${r.name}')" style="color:red; border:none; background:none;">[X]</button> ${r.name}</li>`).join('');
            document.getElementById('roleList').innerHTML = roles.map(r => `<li><button onclick="deleteRobot('${r.robot_id}')" style="color:red; border:none; background:none;">[X]</button> ${r.robot_id}: ${r.role}</li>`).join('');
            drawMap(rooms);
        }
        socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    const { robotId, action, progress, destination } = data;

    if (!robots[robotId]) {
        const card = document.createElement('div');
        card.className = 'robot-card';
        card.innerHTML = `
            <h3>ü§ñ ${robotId}</h3>
            <div class="progress-bg"><div id="fill-${robotId}" class="progress-fill"></div></div>
            <p id="status-${robotId}">${action}</p>
            <div id="log-${robotId}" class="log"></div>
        `;
        fleet.appendChild(card);
        robots[robotId] = card;
    }
    
    document.getElementById(`fill-${robotId}`).style.width = `${progress}%`;
    document.getElementById(`status-${robotId}`).innerText = action;
    
    const logBox = document.getElementById(`log-${robotId}`);
    const logEntry = document.createElement('div');
    logEntry.innerText = `[${new Date().toLocaleTimeString()}] ${action}`;
    logBox.prepend(logEntry);

    if (destination && roomCoords[destination]) {
        const target = roomCoords[destination];
        const startX = 0; 
        const startY = 0;

        const p = progress / 100;
        robotPositions[robotId] = {
            x: startX + (target.x - startX) * p,
            y: startY + (target.y - startY) * p
        };
        drawMap(Object.values(roomCoords).map(c => ({
            ...c, 
            name: Object.keys(roomCoords).find(k => roomCoords[k] === c)
        })));
    }
};

        refreshWorldData();
    </script>
</body>
</html>